# nginx configuration for memory.integrolabs.net
# HotM SPA + Fortemi API + MCP Server
#
# Install:
#   sudo cp deploy/nginx/memory.integrolabs.net.conf /etc/nginx/sites-available/memory
#   sudo ln -sf /etc/nginx/sites-available/memory /etc/nginx/sites-enabled/memory
#   sudo nginx -t && sudo systemctl reload nginx
#
# Architecture:
#   /           → HotM React SPA (port 4180)
#   /api/       → Fortemi API (port 3000)
#   /oauth/     → Fortemi OAuth endpoints (port 3000)
#   /mcp        → MCP Server (port 3001)
#
# IMPORTANT: When deploying HotM SPA at root (/), OAuth and API endpoints
# MUST be explicitly routed BEFORE the SPA catch-all. See deploy/nginx/README.md

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name memory.integrolabs.net;

    # SSL (shared wildcard cert)
    ssl_certificate /etc/nginx/ssl/integrolabs.net.crt;
    ssl_certificate_key /etc/nginx/ssl/integrolabs.net.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # Logging
    access_log /var/log/nginx/memory_access.log;
    error_log /var/log/nginx/memory_error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # =========================================================================
    # CRITICAL: Route ordering matters! Place specific paths BEFORE catch-all
    # =========================================================================

    # -------------------------------------------------------------------------
    # MCP Server (must come before API to avoid /mcp matching /m*)
    # -------------------------------------------------------------------------

    # MCP Server - exact match for /mcp (no trailing slash)
    location = /mcp {
        proxy_pass http://127.0.0.1:3001/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;

        # MCP Session ID for StreamableHTTP transport
        proxy_set_header MCP-Session-Id $http_mcp_session_id;
        proxy_pass_header MCP-Session-Id;

        # SSE support
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
        proxy_read_timeout 86400s;
    }

    # MCP Server - /mcp/ and subpaths
    location /mcp/ {
        proxy_pass http://127.0.0.1:3001/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;

        # MCP Session ID for StreamableHTTP transport
        proxy_set_header MCP-Session-Id $http_mcp_session_id;
        proxy_pass_header MCP-Session-Id;

        # SSE support
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
        proxy_read_timeout 86400s;
    }

    # -------------------------------------------------------------------------
    # OAuth endpoints - MUST route to API, not SPA
    # Without these, OAuth returns 405 HTML from SPA instead of JSON from API
    # -------------------------------------------------------------------------

    # OAuth Discovery (RFC 8414)
    location = /.well-known/oauth-authorization-server {
        proxy_pass http://127.0.0.1:3000/.well-known/oauth-authorization-server;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OAuth endpoints (authorize, token, register, introspect, revoke)
    location /oauth/ {
        proxy_pass http://127.0.0.1:3000/oauth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # -------------------------------------------------------------------------
    # Fortemi API
    # -------------------------------------------------------------------------

    # Health check endpoint - Fortemi uses /health not /api/v1/health
    location = /api/v1/health {
        proxy_pass http://127.0.0.1:3000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Labels endpoint - Fortemi uses /tags not /labels
    location = /api/v1/labels {
        proxy_pass http://127.0.0.1:3000/api/v1/tags;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket endpoint - Fortemi doesn't have WS yet, return 503
    location = /api/v1/ws {
        return 503 "WebSocket not available";
    }

    # Fortemi API - proxy /api requests
    location /api/ {
        proxy_pass http://127.0.0.1:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (for future WS endpoints)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Streaming support (SSE)
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;

        # Large request bodies
        client_max_body_size 50M;
    }

    # -------------------------------------------------------------------------
    # HotM React SPA - MUST be LAST (catch-all)
    # -------------------------------------------------------------------------

    location / {
        proxy_pass http://127.0.0.1:4180;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (HMR in development)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_read_timeout 60s;
    }
}

# HTTP to HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name memory.integrolabs.net;
    return 301 https://$host$request_uri;
}
