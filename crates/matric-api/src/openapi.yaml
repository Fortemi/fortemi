openapi: 3.1.0
info:
  title: Fortémi API
  description: |
    AI-enhanced knowledge base with semantic search, automatic linking, and NLP pipelines.

    ## Features
    - **Notes**: CRUD operations for markdown notes with AI revision
    - **Search**: Hybrid search (FTS + semantic + RRF fusion) with multilingual support
    - **SKOS Taxonomy**: W3C SKOS concept schemes, concepts, and collections
    - **Collections**: Hierarchical folder organization for notes
    - **Templates**: Note templates with variable substitution
    - **Versioning**: Dual-track version history (original + revised)
    - **Embeddings**: Configurable embedding sets with MRL support
    - **Document Types**: 131 pre-configured types with auto-detection
    - **Archives**: Named archive containers with retention policies
    - **Graph**: Recursive semantic link exploration
    - **Backup**: Knowledge shards, database backups, and knowledge archives
    - **Observability**: Knowledge health dashboard, timeline, activity feeds
    - **Jobs**: Background NLP pipeline monitoring
    - **OAuth2**: Full OAuth2 with Dynamic Client Registration (RFC 7591)

    ## Authentication
    The API supports two authentication methods:
    - **OAuth2**: Authorization Code, Client Credentials, and Refresh Token grants
    - **API Keys**: Simple Bearer token authentication for trusted integrations

    ## Search Query Syntax
    ```
    hello world        # Match all words (AND)
    apple OR orange    # Match either word
    apple -orange      # Exclude word
    "hello world"      # Match exact phrase
    ```

    Supports 13+ languages including CJK, Arabic, Cyrillic, and emoji search.
  version: 2026.2.0
  contact:
    name: Matric Memory Team
    url: https://github.com/fortemi/fortemi

servers:
  - url: /
    description: Production server

security:
  - bearerAuth: []
  - oauth2: []

tags:
  - name: OAuth
    description: OAuth2 authentication endpoints (RFC 7591, 7662, 7009)
  - name: API Keys
    description: API key management
  - name: System
    description: Health check, memory info, and rate limiting
  - name: Events
    description: Real-time event streaming via WebSocket and SSE
  - name: Webhooks
    description: Outbound HTTP webhook notifications
  - name: Notes
    description: Note CRUD operations with AI revision pipeline
  - name: Versioning
    description: Note version history and diffs
  - name: Tags
    description: Tag management
  - name: Links
    description: Semantic and explicit note relationships
  - name: Search
    description: Full-text, semantic, and hybrid search
  - name: Analytics
    description: Timeline, activity feeds, and usage statistics
  - name: Health
    description: Knowledge health dashboard and diagnostics
  - name: SKOS
    description: W3C SKOS concept schemes, concepts, and collections
  - name: Document Types
    description: Document type registry with auto-detection
  - name: Archives
    description: Named archive containers with retention policies
  - name: Collections
    description: Hierarchical note folders
  - name: Embeddings
    description: Embedding sets and configurations
  - name: Graph
    description: Semantic link graph exploration
  - name: Templates
    description: Note templates with variable substitution
  - name: Jobs
    description: Background NLP job management
  - name: Backup
    description: Export, import, and database backup operations

paths:
  # ===========================================================================
  # OAuth2
  # ===========================================================================
  /.well-known/oauth-authorization-server:
    get:
      summary: OAuth2 Authorization Server Metadata
      description: Returns OAuth2 server metadata per RFC 8414
      operationId: oauthDiscovery
      tags: [OAuth]
      security: []
      responses:
        '200':
          description: Authorization server metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthorizationServerMetadata'

  /.well-known/oauth-protected-resource:
    get:
      summary: Protected Resource Metadata
      description: Returns OAuth2 protected resource metadata
      operationId: oauthProtectedResource
      tags: [OAuth]
      security: []
      responses:
        '200':
          description: Protected resource metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  resource:
                    type: string
                  authorization_servers:
                    type: array
                    items:
                      type: string

  /oauth/authorize:
    get:
      summary: Authorization Page
      description: Display OAuth2 authorization page for user consent (browser flow)
      operationId: oauthAuthorizeGet
      tags: [OAuth]
      security: []
      parameters:
        - name: client_id
          in: query
          required: true
          schema:
            type: string
        - name: redirect_uri
          in: query
          required: true
          schema:
            type: string
            format: uri
        - name: response_type
          in: query
          required: true
          schema:
            type: string
            enum: [code]
        - name: scope
          in: query
          schema:
            type: string
        - name: state
          in: query
          schema:
            type: string
        - name: code_challenge
          in: query
          schema:
            type: string
        - name: code_challenge_method
          in: query
          schema:
            type: string
            enum: [S256, plain]
      responses:
        '200':
          description: Authorization page HTML
          content:
            text/html:
              schema:
                type: string

    post:
      summary: Submit Authorization Decision
      description: User submits approval or denial of authorization request
      operationId: oauthAuthorizePost
      tags: [OAuth]
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                client_id:
                  type: string
                redirect_uri:
                  type: string
                state:
                  type: string
                scope:
                  type: string
                approved:
                  type: string
                  enum: ["true", "false"]
      responses:
        '302':
          description: Redirect with authorization code or error

  /oauth/register:
    post:
      summary: Register OAuth2 Client
      description: Dynamic Client Registration per RFC 7591
      operationId: oauthRegister
      tags: [OAuth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientRegistrationRequest'
      responses:
        '201':
          description: Client registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientRegistrationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'

  /oauth/token:
    post:
      summary: Request Access Token
      description: Token endpoint supporting authorization_code, client_credentials, and refresh_token grants
      operationId: oauthToken
      tags: [OAuth]
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/TokenRequest'
      responses:
        '200':
          description: Token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'
        '401':
          description: Invalid client credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthError'

  /oauth/introspect:
    post:
      summary: Introspect Token
      description: Token introspection per RFC 7662
      operationId: oauthIntrospect
      tags: [OAuth]
      security:
        - clientCredentials: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                token_type_hint:
                  type: string
                  enum: [access_token, refresh_token]
      responses:
        '200':
          description: Token introspection result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenIntrospectionResponse'

  /oauth/revoke:
    post:
      summary: Revoke Token
      description: Token revocation per RFC 7009
      operationId: oauthRevoke
      tags: [OAuth]
      security:
        - clientCredentials: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [token]
              properties:
                token:
                  type: string
                token_type_hint:
                  type: string
                  enum: [access_token, refresh_token]
      responses:
        '200':
          description: Token revoked

  # ===========================================================================
  # API Keys
  # ===========================================================================
  /api/v1/api-keys:
    get:
      summary: List API Keys
      operationId: listApiKeys
      tags: [API Keys]
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  api_keys:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApiKey'

    post:
      summary: Create API Key
      operationId: createApiKey
      tags: [API Keys]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
      responses:
        '201':
          description: API key created (key shown only once)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'

  /api/v1/api-keys/{id}:
    delete:
      summary: Revoke API Key
      operationId: revokeApiKey
      tags: [API Keys]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: API key revoked
        '404':
          $ref: '#/components/responses/NotFound'

  # ===========================================================================
  # System
  # ===========================================================================
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      tags: [System]
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  version:
                    type: string
                    example: 2026.2.0

  /api/v1/memory/info:
    get:
      summary: Get memory system info
      description: Database size, note count, embedding count, and system statistics
      operationId: getMemoryInfo
      tags: [System]
      responses:
        '200':
          description: System information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryInfo'

  /api/v1/rate-limit/status:
    get:
      summary: Get rate limit status
      operationId: getRateLimitStatus
      tags: [System]
      responses:
        '200':
          description: Rate limit information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitStatus'

  # ===========================================================================
  # Real-Time Events (Issues #38-#45)
  # ===========================================================================
  /api/v1/ws:
    get:
      summary: WebSocket event stream
      operationId: wsEvents
      tags: [Events]
      description: |
        Upgrade to WebSocket for real-time ServerEvent JSON messages.
        Send "refresh" to receive an immediate QueueStatus.
        7 event types: QueueStatus, JobQueued, JobStarted, JobProgress, JobCompleted, JobFailed, NoteUpdated.
      responses:
        '101':
          description: WebSocket upgrade

  /api/v1/events:
    get:
      summary: Server-Sent Events stream
      operationId: sseEvents
      tags: [Events]
      description: |
        SSE endpoint for real-time event streaming. Each event has a named `event` field
        (e.g., "JobStarted") and JSON `data`.
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string

  /api/v1/webhooks:
    post:
      summary: Register a webhook
      operationId: createWebhook
      tags: [Webhooks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWebhookRequest'
      responses:
        '201':
          description: Webhook created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
    get:
      summary: List all webhooks
      operationId: listWebhooks
      tags: [Webhooks]
      responses:
        '200':
          description: List of webhooks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Webhook'

  /api/v1/webhooks/{id}:
    get:
      summary: Get webhook details
      operationId: getWebhook
      tags: [Webhooks]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhook details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'
    patch:
      summary: Update webhook
      operationId: updateWebhook
      tags: [Webhooks]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                is_active:
                  type: boolean
      responses:
        '200':
          description: Updated webhook
    delete:
      summary: Delete webhook
      operationId: deleteWebhook
      tags: [Webhooks]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Webhook deleted

  /api/v1/webhooks/{id}/deliveries:
    get:
      summary: View webhook delivery history
      operationId: listWebhookDeliveries
      tags: [Webhooks]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Delivery history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WebhookDelivery'

  /api/v1/webhooks/{id}/test:
    post:
      summary: Send test webhook event
      operationId: testWebhook
      tags: [Webhooks]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Test delivered

  # ===========================================================================
  # Notes CRUD
  # ===========================================================================
  /api/v1/notes:
    get:
      summary: List notes
      operationId: listNotes
      tags: [Notes]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: filter
          in: query
          description: Filter expression (starred, archived)
          schema:
            type: string
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [created_at_utc, updated_at_utc, title]
        - name: sort_order
          in: query
          schema:
            type: string
            enum: [asc, desc]
        - name: collection_id
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Paginated list of notes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotesListResponse'

    post:
      summary: Create a note
      description: Creates a note and queues NLP pipeline (revision, embedding, linking, tagging)
      operationId: createNote
      tags: [Notes]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNoteRequest'
      responses:
        '201':
          description: Note created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid

  /api/v1/notes/bulk:
    post:
      summary: Bulk create notes
      description: Create multiple notes in a single request
      operationId: bulkCreateNotes
      tags: [Notes]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [notes]
              properties:
                notes:
                  type: array
                  items:
                    $ref: '#/components/schemas/CreateNoteRequest'
      responses:
        '201':
          description: Notes created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ids:
                    type: array
                    items:
                      type: string
                      format: uuid

  /api/v1/notes/{id}:
    get:
      summary: Get a note
      operationId: getNote
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Full note details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteFull'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update a note
      operationId: updateNote
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateNoteRequest'
      responses:
        '204':
          description: Note updated

    delete:
      summary: Delete a note (soft delete)
      operationId: deleteNote
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '204':
          description: Note soft-deleted

  /api/v1/notes/{id}/status:
    patch:
      summary: Update note status
      description: Quick endpoint for starring/archiving without content changes
      operationId: updateNoteStatus
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                starred:
                  type: boolean
                archived:
                  type: boolean
      responses:
        '204':
          description: Status updated

  /api/v1/notes/{id}/restore:
    post:
      summary: Restore a deleted note
      operationId: restoreNote
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '204':
          description: Note restored

  /api/v1/notes/{id}/purge:
    post:
      summary: Permanently delete note
      description: Permanently deletes a note and all associated data (versions, links, embeddings)
      operationId: purgeNote
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '204':
          description: Note permanently deleted

  /api/v1/notes/{id}/reprocess:
    post:
      summary: Reprocess note through NLP pipeline
      description: Re-queues embedding, linking, and optionally AI revision jobs
      operationId: reprocessNote
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                revision_mode:
                  type: string
                  enum: [full, light, none]
                  default: none
      responses:
        '202':
          description: Reprocessing jobs queued

  /api/v1/notes/{id}/tags:
    get:
      summary: Get note tags
      operationId: getNoteTags
      tags: [Tags]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: List of tag names
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

    put:
      summary: Set note tags
      description: Replace all tags on a note
      operationId: setNoteTags
      tags: [Tags]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [tags]
              properties:
                tags:
                  type: array
                  items:
                    type: string
      responses:
        '204':
          description: Tags updated

  /api/v1/notes/{id}/links:
    get:
      summary: Get note links
      operationId: getNoteLinks
      tags: [Links]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Outgoing and incoming links
          content:
            application/json:
              schema:
                type: object
                properties:
                  outgoing:
                    type: array
                    items:
                      $ref: '#/components/schemas/Link'
                  incoming:
                    type: array
                    items:
                      $ref: '#/components/schemas/Link'

  /api/v1/notes/{id}/backlinks:
    get:
      summary: Get note backlinks
      description: Get all notes that link TO this note
      operationId: getNoteBacklinks
      tags: [Links]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Notes linking to this note
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Link'

  /api/v1/notes/{id}/export:
    get:
      summary: Export note as markdown
      description: Export note with YAML frontmatter (tags, timestamps, metadata)
      operationId: exportNote
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Markdown with YAML frontmatter
          content:
            text/markdown:
              schema:
                type: string

  /api/v1/notes/{id}/full:
    get:
      summary: Get full reconstructed document
      description: For chunked documents, stitches all chunks together. For regular notes, returns content as-is.
      operationId: getFullDocument
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Full reconstructed document
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullDocumentResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/notes/{id}/provenance:
    get:
      summary: Get note provenance
      description: W3C PROV provenance chain showing AI processing history
      operationId: getNoteProvenance
      tags: [Notes]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Provenance chain
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProvenanceResponse'

  # ===========================================================================
  # Memory Search
  # ===========================================================================
  /api/v1/memories/search:
    get:
      summary: Search memories by location, time, or both
      description: |
        Unified spatiotemporal search endpoint. Mode is determined by which query parameters are provided:
        - `lat` + `lon` → location mode (spatial search)
        - `start` + `end` → time mode (temporal search)
        - All parameters → combined mode (intersection)
        At least one search dimension is required.
      operationId: searchMemories
      tags: [Memory Search]
      parameters:
        - name: lat
          in: query
          description: Latitude in decimal degrees (-90 to 90)
          schema:
            type: number
            format: double
        - name: lon
          in: query
          description: Longitude in decimal degrees (-180 to 180)
          schema:
            type: number
            format: double
        - name: radius
          in: query
          description: Search radius in meters (default 1000)
          schema:
            type: number
            format: double
            default: 1000
        - name: start
          in: query
          description: Start of time range (ISO 8601 or flexible format)
          schema:
            type: string
            format: date-time
        - name: end
          in: query
          description: End of time range (ISO 8601 or flexible format)
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                required: [mode, results, count]
                properties:
                  mode:
                    type: string
                    enum: [location, time, combined]
                  results:
                    type: array
                    items:
                      type: object
                  count:
                    type: integer
        '400':
          description: No search dimension provided

  /api/v1/notes/{id}/memory-provenance:
    get:
      summary: Get memory provenance for a note
      description: Returns the complete file provenance chain for a note's attachments, including location, device, and capture time information.
      operationId: getMemoryProvenance
      tags: [Memory Search]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Memory provenance (files array is empty if no provenance exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  note_id:
                    type: string
                    format: uuid
                  files:
                    type: array
                    items:
                      type: object

  /api/v1/notes/{id}/move:
    post:
      summary: Move note to collection
      operationId: moveNoteToCollection
      tags: [Collections]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                collection_id:
                  type: string
                  format: uuid
                  nullable: true
                  description: Target collection ID (null to remove from collection)
      responses:
        '204':
          description: Note moved

  # ===========================================================================
  # Note Versioning
  # ===========================================================================
  /api/v1/notes/{id}/versions:
    get:
      summary: List note versions
      operationId: listNoteVersions
      tags: [Versioning]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Version history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NoteVersion'

  /api/v1/notes/{id}/versions/{version}:
    get:
      summary: Get specific version
      operationId: getNoteVersion
      tags: [Versioning]
      parameters:
        - $ref: '#/components/parameters/NoteId'
        - $ref: '#/components/parameters/VersionNumber'
      responses:
        '200':
          description: Version content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteVersionFull'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete specific version
      description: Cannot delete current (HEAD) version
      operationId: deleteNoteVersion
      tags: [Versioning]
      parameters:
        - $ref: '#/components/parameters/NoteId'
        - $ref: '#/components/parameters/VersionNumber'
      responses:
        '204':
          description: Version deleted
        '400':
          description: Cannot delete current version

  /api/v1/notes/{id}/versions/{version}/restore:
    post:
      summary: Restore version
      description: Restores a previous version, creating a new version in the history
      operationId: restoreNoteVersion
      tags: [Versioning]
      parameters:
        - $ref: '#/components/parameters/NoteId'
        - $ref: '#/components/parameters/VersionNumber'
      responses:
        '204':
          description: Version restored

  /api/v1/notes/{id}/versions/diff:
    get:
      summary: Diff two versions
      operationId: diffNoteVersions
      tags: [Versioning]
      parameters:
        - $ref: '#/components/parameters/NoteId'
        - name: from
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
        - name: to
          in: query
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Unified diff
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionDiff'

  # ===========================================================================
  # Search
  # ===========================================================================
  /api/v1/search:
    get:
      summary: Search notes
      description: |
        Hybrid search combining FTS and semantic similarity with RRF fusion.
        Supports query operators: OR, NOT (-), phrase search ("...").
        Multilingual support for 13+ languages including CJK and emoji.
      operationId: searchNotes
      tags: [Search]
      parameters:
        - name: q
          in: query
          required: true
          description: Search query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: mode
          in: query
          description: Search mode
          schema:
            type: string
            enum: [hybrid, fts, semantic]
            default: hybrid
        - name: filters
          in: query
          description: Filter expression
          schema:
            type: string
        - name: tags
          in: query
          description: Comma-separated tag filter
          schema:
            type: string
        - name: collection_id
          in: query
          schema:
            type: string
            format: uuid
        - name: strict_filter
          in: query
          description: JSON-encoded StrictTagFilterInput
          schema:
            type: string
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'

  # ===========================================================================
  # Analytics (Timeline / Activity)
  # ===========================================================================
  /api/v1/notes/timeline:
    get:
      summary: Get notes timeline
      description: Note creation/update counts grouped by time period
      operationId: getNotesTimeline
      tags: [Analytics]
      parameters:
        - name: granularity
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: day
        - name: start
          in: query
          schema:
            type: string
            format: date-time
        - name: end
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Timeline data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimelineResponse'

  /api/v1/notes/activity:
    get:
      summary: Get recent note activity
      operationId: getNotesActivity
      tags: [Analytics]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Activity feed
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/ActivityEvent'
                  total:
                    type: integer

  # ===========================================================================
  # Knowledge Health
  # ===========================================================================
  /api/v1/health/knowledge:
    get:
      summary: Knowledge health dashboard
      description: Comprehensive health metrics for the knowledge base
      operationId: getKnowledgeHealth
      tags: [Health]
      responses:
        '200':
          description: Health metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeHealth'

  /api/v1/health/orphan-tags:
    get:
      summary: List orphan tags
      description: Tags not attached to any notes
      operationId: getOrphanTags
      tags: [Health]
      responses:
        '200':
          description: Orphan tag names
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /api/v1/health/stale-notes:
    get:
      summary: List stale notes
      description: Notes not updated within specified period
      operationId: getStaleNotes
      tags: [Health]
      parameters:
        - name: days
          in: query
          schema:
            type: integer
            default: 90
      responses:
        '200':
          description: Stale notes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NoteSummary'

  /api/v1/health/unlinked-notes:
    get:
      summary: List unlinked notes
      description: Notes with no semantic links
      operationId: getUnlinkedNotes
      tags: [Health]
      responses:
        '200':
          description: Unlinked notes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NoteSummary'

  /api/v1/health/tag-cooccurrence:
    get:
      summary: Tag co-occurrence matrix
      operationId: getTagCooccurrence
      tags: [Health]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Co-occurrence data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagCooccurrence'

  # ===========================================================================
  # Tags
  # ===========================================================================
  /api/v1/tags:
    get:
      summary: List all tags
      operationId: listTags
      tags: [Tags]
      responses:
        '200':
          description: List of tags
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tag'

  # ===========================================================================
  # Jobs
  # ===========================================================================
  /api/v1/jobs:
    get:
      summary: List recent jobs
      operationId: listJobs
      tags: [Jobs]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed, cancelled]
      responses:
        '200':
          description: List of jobs
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Job'

    post:
      summary: Create a job
      operationId: createJob
      tags: [Jobs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid

  /api/v1/jobs/{id}:
    get:
      summary: Get job status
      operationId: getJob
      tags: [Jobs]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Job details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/jobs/pending:
    get:
      summary: Get pending jobs count
      operationId: pendingJobsCount
      tags: [Jobs]
      responses:
        '200':
          description: Pending count
          content:
            application/json:
              schema:
                type: object
                properties:
                  pending:
                    type: integer

  /api/v1/jobs/stats:
    get:
      summary: Get job queue statistics
      description: Counts by status and job type
      operationId: getJobStats
      tags: [Jobs]
      responses:
        '200':
          description: Queue statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStats'

  # ===========================================================================
  # Document Types
  # ===========================================================================
  /api/v1/document-types:
    get:
      summary: List document types
      description: Returns all document types including 131 pre-configured types
      operationId: listDocumentTypes
      tags: [Document Types]
      responses:
        '200':
          description: Document types
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DocumentType'

    post:
      summary: Create custom document type
      operationId: createDocumentType
      tags: [Document Types]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, chunk_strategy]
              properties:
                name:
                  type: string
                description:
                  type: string
                filename_patterns:
                  type: array
                  items:
                    type: string
                magic_content_patterns:
                  type: array
                  items:
                    type: string
                chunk_strategy:
                  type: string
                  enum: [semantic, syntactic, fixed, none]
                chunk_size:
                  type: integer
                chunk_overlap:
                  type: integer
      responses:
        '201':
          description: Document type created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentType'

  /api/v1/document-types/{name}:
    get:
      summary: Get document type
      operationId: getDocumentType
      tags: [Document Types]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Document type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentType'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update document type
      operationId: updateDocumentType
      tags: [Document Types]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                description:
                  type: string
                filename_patterns:
                  type: array
                  items:
                    type: string
                chunk_strategy:
                  type: string
                  enum: [semantic, syntactic, fixed, none]
                chunk_size:
                  type: integer
                chunk_overlap:
                  type: integer
      responses:
        '204':
          description: Updated

    delete:
      summary: Delete custom document type
      operationId: deleteDocumentType
      tags: [Document Types]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted
        '403':
          description: Cannot delete built-in type

  /api/v1/document-types/detect:
    post:
      summary: Auto-detect document type
      description: Detect type from filename and optional content sample
      operationId: detectDocumentType
      tags: [Document Types]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename]
              properties:
                filename:
                  type: string
                content:
                  type: string
      responses:
        '200':
          description: Detection result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetectDocumentTypeResponse'

  # ===========================================================================
  # Archives
  # ===========================================================================
  /api/v1/archives:
    get:
      summary: List archives
      operationId: listArchives
      tags: [Archives]
      responses:
        '200':
          description: Archives
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Archive'

    post:
      summary: Create archive
      operationId: createArchive
      tags: [Archives]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
                retention_policy:
                  type: string
      responses:
        '201':
          description: Archive created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Archive'

  /api/v1/archives/{name}:
    get:
      summary: Get archive
      operationId: getArchive
      tags: [Archives]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Archive details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Archive'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update archive
      operationId: updateArchive
      tags: [Archives]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                description:
                  type: string
                retention_policy:
                  type: string
      responses:
        '204':
          description: Updated

    delete:
      summary: Delete archive
      operationId: deleteArchive
      tags: [Archives]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted

  /api/v1/archives/{name}/set-default:
    post:
      summary: Set default archive
      operationId: setDefaultArchive
      tags: [Archives]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Default archive set

  /api/v1/archives/{name}/stats:
    get:
      summary: Get archive statistics
      operationId: getArchiveStats
      tags: [Archives]
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Archive statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArchiveStats'

  # ===========================================================================
  # SKOS Concept Schemes
  # ===========================================================================
  /api/v1/concepts/schemes:
    get:
      summary: List concept schemes
      operationId: listConceptSchemes
      tags: [SKOS]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Concept schemes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ConceptScheme'

    post:
      summary: Create concept scheme
      operationId: createConceptScheme
      tags: [SKOS]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title, notation]
              properties:
                title:
                  type: string
                description:
                  type: string
                notation:
                  type: string
                uri:
                  type: string
      responses:
        '201':
          description: Scheme created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConceptScheme'

  /api/v1/concepts/schemes/{id}:
    get:
      summary: Get concept scheme
      operationId: getConceptScheme
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Concept scheme
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConceptScheme'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update concept scheme
      operationId: updateConceptScheme
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                notation:
                  type: string
                uri:
                  type: string
      responses:
        '204':
          description: Updated

  /api/v1/concepts/schemes/{id}/top-concepts:
    get:
      summary: Get top-level concepts in scheme
      operationId: getTopConcepts
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Top-level concepts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Concept'

  /api/v1/concepts/schemes/{id}/export/turtle:
    get:
      summary: Export scheme as Turtle/RDF
      description: Export concept scheme in W3C Turtle format
      operationId: exportSchemeTurtle
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Turtle/RDF content
          content:
            text/turtle:
              schema:
                type: string

  # ===========================================================================
  # SKOS Concepts
  # ===========================================================================
  /api/v1/concepts:
    get:
      summary: Search/list concepts
      operationId: searchConcepts
      tags: [SKOS]
      parameters:
        - name: q
          in: query
          schema:
            type: string
        - name: scheme_id
          in: query
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Concepts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Concept'

    post:
      summary: Create concept
      operationId: createConcept
      tags: [SKOS]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pref_label, scheme_id, notation]
              properties:
                pref_label:
                  type: string
                scheme_id:
                  type: string
                  format: uuid
                notation:
                  type: string
                definition:
                  type: string
                scope_note:
                  type: string
                alt_labels:
                  type: array
                  items:
                    type: string
                hidden_labels:
                  type: array
                  items:
                    type: string
                status:
                  type: string
                  enum: [active, deprecated, proposed]
                  default: active
                facet_type:
                  type: string
      responses:
        '201':
          description: Concept created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Concept'

  /api/v1/concepts/autocomplete:
    get:
      summary: Autocomplete concepts
      operationId: autocompleteConcepts
      tags: [SKOS]
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
      responses:
        '200':
          description: Concept suggestions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ConceptSuggestion'

  /api/v1/concepts/{id}:
    get:
      summary: Get concept
      operationId: getConcept
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      responses:
        '200':
          description: Concept
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Concept'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update concept
      operationId: updateConcept
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                pref_label:
                  type: string
                notation:
                  type: string
                definition:
                  type: string
                scope_note:
                  type: string
                alt_labels:
                  type: array
                  items:
                    type: string
                hidden_labels:
                  type: array
                  items:
                    type: string
                status:
                  type: string
                  enum: [active, deprecated, proposed]
                deprecation_reason:
                  type: string
                facet_type:
                  type: string
      responses:
        '204':
          description: Updated

    delete:
      summary: Delete concept
      operationId: deleteConcept
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      responses:
        '204':
          description: Deleted

  /api/v1/concepts/{id}/full:
    get:
      summary: Get concept with full hierarchy
      operationId: getConceptFull
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      responses:
        '200':
          description: Concept with broader, narrower, and related
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConceptFull'

  /api/v1/concepts/{id}/ancestors:
    get:
      summary: Get all ancestors
      operationId: getAncestors
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      responses:
        '200':
          description: Ancestor concepts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Concept'

  /api/v1/concepts/{id}/descendants:
    get:
      summary: Get all descendants
      operationId: getDescendants
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      responses:
        '200':
          description: Descendant concepts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Concept'

  /api/v1/concepts/{id}/broader:
    get:
      summary: Get broader concepts
      operationId: getBroader
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      responses:
        '200':
          description: Broader concepts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Concept'

    post:
      summary: Add broader relation
      operationId: addBroader
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [target_id]
              properties:
                target_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Relation added

  /api/v1/concepts/{id}/broader/{target_id}:
    delete:
      summary: Remove broader relation
      operationId: removeBroader
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
        - $ref: '#/components/parameters/TargetConceptId'
      responses:
        '204':
          description: Relation removed

  /api/v1/concepts/{id}/narrower:
    get:
      summary: Get narrower concepts
      operationId: getNarrower
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      responses:
        '200':
          description: Narrower concepts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Concept'

    post:
      summary: Add narrower relation
      operationId: addNarrower
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [target_id]
              properties:
                target_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Relation added

  /api/v1/concepts/{id}/narrower/{target_id}:
    delete:
      summary: Remove narrower relation
      operationId: removeNarrower
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
        - $ref: '#/components/parameters/TargetConceptId'
      responses:
        '204':
          description: Relation removed

  /api/v1/concepts/{id}/related:
    get:
      summary: Get related concepts
      operationId: getRelated
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      responses:
        '200':
          description: Related concepts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Concept'

    post:
      summary: Add related relation
      operationId: addRelated
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [target_id]
              properties:
                target_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Relation added

  /api/v1/concepts/{id}/related/{target_id}:
    delete:
      summary: Remove related relation
      operationId: removeRelated
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/ConceptId'
        - $ref: '#/components/parameters/TargetConceptId'
      responses:
        '204':
          description: Relation removed

  # ===========================================================================
  # SKOS Tagging
  # ===========================================================================
  /api/v1/notes/{id}/concepts:
    get:
      summary: Get concepts tagged on note
      operationId: getNoteConcepts
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      responses:
        '200':
          description: Concepts tagged on this note
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Concept'

    post:
      summary: Tag note with concept
      operationId: tagNoteWithConcept
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/NoteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [concept_id]
              properties:
                concept_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Concept tagged

  /api/v1/notes/{id}/concepts/{concept_id}:
    delete:
      summary: Remove concept tag from note
      operationId: untagNoteConcept
      tags: [SKOS]
      parameters:
        - $ref: '#/components/parameters/NoteId'
        - name: concept_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Concept untagged

  # ===========================================================================
  # SKOS Governance & Collections
  # ===========================================================================
  /api/v1/concepts/governance:
    get:
      summary: Get governance statistics
      operationId: getGovernanceStats
      tags: [SKOS]
      responses:
        '200':
          description: Governance stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GovernanceStats'

  /api/v1/concepts/collections:
    get:
      summary: List SKOS collections
      operationId: listSkosCollections
      tags: [SKOS]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: SKOS collections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SkosCollection'

    post:
      summary: Create SKOS collection
      operationId: createSkosCollection
      tags: [SKOS]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [label]
              properties:
                label:
                  type: string
                description:
                  type: string
                notation:
                  type: string
      responses:
        '201':
          description: Collection created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SkosCollection'

  /api/v1/concepts/collections/{id}:
    get:
      summary: Get SKOS collection
      operationId: getSkosCollection
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: SKOS collection with members
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SkosCollection'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update SKOS collection
      operationId: updateSkosCollection
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                label:
                  type: string
                description:
                  type: string
                notation:
                  type: string
      responses:
        '204':
          description: Updated

    delete:
      summary: Delete SKOS collection
      operationId: deleteSkosCollection
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted

  /api/v1/concepts/collections/{id}/members:
    put:
      summary: Replace all collection members
      operationId: replaceSkosCollectionMembers
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [concept_ids]
              properties:
                concept_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
      responses:
        '204':
          description: Members replaced

  /api/v1/concepts/collections/{id}/members/{concept_id}:
    post:
      summary: Add member to collection
      operationId: addSkosCollectionMember
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: concept_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '201':
          description: Member added

    delete:
      summary: Remove member from collection
      operationId: removeSkosCollectionMember
      tags: [SKOS]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: concept_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Member removed

  # ===========================================================================
  # Collections (Note Folders)
  # ===========================================================================
  /api/v1/collections:
    get:
      summary: List collections
      operationId: listCollections
      tags: [Collections]
      responses:
        '200':
          description: Collections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Collection'

    post:
      summary: Create collection
      operationId: createCollection
      tags: [Collections]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
                parent_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Collection created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Collection'

  /api/v1/collections/{id}:
    get:
      summary: Get collection
      operationId: getCollection
      tags: [Collections]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Collection'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update collection
      operationId: updateCollection
      tags: [Collections]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
      responses:
        '204':
          description: Updated

    delete:
      summary: Delete collection
      operationId: deleteCollection
      tags: [Collections]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted

  /api/v1/collections/{id}/notes:
    get:
      summary: List notes in collection
      operationId: getCollectionNotes
      tags: [Collections]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Notes in collection
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotesListResponse'

  # ===========================================================================
  # Embedding Sets & Configs
  # ===========================================================================
  /api/v1/embedding-sets:
    get:
      summary: List embedding sets
      operationId: listEmbeddingSets
      tags: [Embeddings]
      responses:
        '200':
          description: Embedding sets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EmbeddingSet'

    post:
      summary: Create embedding set
      operationId: createEmbeddingSet
      tags: [Embeddings]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [slug, name, set_type]
              properties:
                slug:
                  type: string
                name:
                  type: string
                description:
                  type: string
                set_type:
                  type: string
                  enum: [filter, full]
                embedding_config_id:
                  type: string
                  format: uuid
                auto_embed_rules:
                  type: object
      responses:
        '201':
          description: Set created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingSet'

  /api/v1/embedding-sets/{slug}:
    get:
      summary: Get embedding set
      operationId: getEmbeddingSet
      tags: [Embeddings]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Embedding set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingSet'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update embedding set
      operationId: updateEmbeddingSet
      tags: [Embeddings]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                auto_embed_rules:
                  type: object
      responses:
        '204':
          description: Updated

    delete:
      summary: Delete embedding set
      operationId: deleteEmbeddingSet
      tags: [Embeddings]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Deleted

  /api/v1/embedding-sets/{slug}/members:
    get:
      summary: List set members
      operationId: listEmbeddingSetMembers
      tags: [Embeddings]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Member note IDs
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                  format: uuid

    post:
      summary: Add members to set
      operationId: addEmbeddingSetMembers
      tags: [Embeddings]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [note_ids]
              properties:
                note_ids:
                  type: array
                  items:
                    type: string
                    format: uuid
      responses:
        '201':
          description: Members added

  /api/v1/embedding-sets/{slug}/members/{note_id}:
    delete:
      summary: Remove member from set
      operationId: removeEmbeddingSetMember
      tags: [Embeddings]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
        - name: note_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Member removed

  /api/v1/embedding-sets/{slug}/refresh:
    post:
      summary: Refresh set embeddings
      description: Queue re-embedding of all notes in the set
      operationId: refreshEmbeddingSet
      tags: [Embeddings]
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
      responses:
        '202':
          description: Refresh jobs queued

  /api/v1/embedding-configs:
    get:
      summary: List embedding configs
      operationId: listEmbeddingConfigs
      tags: [Embeddings]
      responses:
        '200':
          description: Embedding configurations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EmbeddingConfig'

    post:
      summary: Create embedding config
      operationId: createEmbeddingConfig
      tags: [Embeddings]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, model_name, dimensions]
              properties:
                name:
                  type: string
                model_name:
                  type: string
                dimensions:
                  type: integer
                distance_metric:
                  type: string
                  enum: [cosine, l2, ip]
                  default: cosine
                mrl_dimensions:
                  type: integer
                  description: MRL dimensions for 12x storage savings
                description:
                  type: string
      responses:
        '201':
          description: Config created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingConfig'

  /api/v1/embedding-configs/default:
    get:
      summary: Get default embedding config
      operationId: getDefaultEmbeddingConfig
      tags: [Embeddings]
      responses:
        '200':
          description: Default config
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingConfig'

  /api/v1/embedding-configs/{id}:
    get:
      summary: Get embedding config
      operationId: getEmbeddingConfig
      tags: [Embeddings]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Embedding config
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingConfig'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update embedding config
      operationId: updateEmbeddingConfig
      tags: [Embeddings]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                mrl_dimensions:
                  type: integer
                description:
                  type: string
      responses:
        '204':
          description: Updated

    delete:
      summary: Delete embedding config
      operationId: deleteEmbeddingConfig
      tags: [Embeddings]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted

  # ===========================================================================
  # Graph Exploration
  # ===========================================================================
  /api/v1/graph/{id}:
    get:
      summary: Explore note graph
      description: Recursive CTE traversal of semantic link graph
      operationId: exploreGraph
      tags: [Graph]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: depth
          in: query
          schema:
            type: integer
            default: 2
        - name: max_nodes
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Graph data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphResponse'

  # ===========================================================================
  # Templates
  # ===========================================================================
  /api/v1/templates:
    get:
      summary: List templates
      operationId: listTemplates
      tags: [Templates]
      responses:
        '200':
          description: Templates
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Template'

    post:
      summary: Create template
      operationId: createTemplate
      tags: [Templates]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, content]
              properties:
                name:
                  type: string
                description:
                  type: string
                content:
                  type: string
                  description: Template with {{variable}} placeholders
                tags:
                  type: array
                  items:
                    type: string
                category:
                  type: string
      responses:
        '201':
          description: Template created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'

  /api/v1/templates/{id}:
    get:
      summary: Get template
      operationId: getTemplate
      tags: [Templates]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: Update template
      operationId: updateTemplate
      tags: [Templates]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                content:
                  type: string
                tags:
                  type: array
                  items:
                    type: string
                category:
                  type: string
      responses:
        '204':
          description: Updated

    delete:
      summary: Delete template
      operationId: deleteTemplate
      tags: [Templates]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted

  /api/v1/templates/{id}/instantiate:
    post:
      summary: Create note from template
      description: Substitutes {{variable}} placeholders with provided values
      operationId: instantiateTemplate
      tags: [Templates]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [variables]
              properties:
                variables:
                  type: object
                  additionalProperties:
                    type: string
                tags:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: Note created from template
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid

  # ===========================================================================
  # Backup & Export
  # ===========================================================================
  /api/v1/backup/export:
    get:
      summary: Export all notes as JSON
      operationId: backupExport
      tags: [Backup]
      parameters:
        - name: filter
          in: query
          schema:
            type: string
        - name: starred
          in: query
          schema:
            type: boolean
        - name: tags
          in: query
          schema:
            type: string
      responses:
        '200':
          description: JSON export
          content:
            application/json:
              schema:
                type: object

  /api/v1/backup/download:
    get:
      summary: Download backup file
      operationId: backupDownload
      tags: [Backup]
      parameters:
        - name: starred_only
          in: query
          schema:
            type: boolean
        - name: tags
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Backup file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /api/v1/backup/import:
    post:
      summary: Import notes from backup
      operationId: backupImport
      tags: [Backup]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Import result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportResult'

  /api/v1/backup/trigger:
    post:
      summary: Trigger backup creation
      operationId: backupTrigger
      tags: [Backup]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                dry_run:
                  type: boolean
                  default: false
      responses:
        '202':
          description: Backup job queued

  /api/v1/backup/status:
    get:
      summary: Get backup status
      operationId: backupStatus
      tags: [Backup]
      responses:
        '200':
          description: Backup system status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackupStatus'

  /api/v1/backup/knowledge-shard:
    get:
      summary: Export as knowledge shard
      description: Portable knowledge base export format
      operationId: knowledgeShard
      tags: [Backup]
      parameters:
        - name: include
          in: query
          schema:
            type: string
        - name: starred_only
          in: query
          schema:
            type: boolean
        - name: tags
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Knowledge shard JSON
          content:
            application/json:
              schema:
                type: object

  /api/v1/backup/knowledge-shard/import:
    post:
      summary: Import knowledge shard
      operationId: knowledgeShardImport
      tags: [Backup]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dry_run:
                  type: boolean
                  default: false
                on_conflict:
                  type: string
                  enum: [skip, overwrite, merge]
                  default: skip
                skip_embedding_regen:
                  type: boolean
                  default: false
      responses:
        '200':
          description: Import result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportResult'

  /api/v1/backup/database:
    get:
      summary: Download database backup (pg_dump)
      operationId: databaseBackupDownload
      tags: [Backup]
      responses:
        '200':
          description: Database backup file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /api/v1/backup/database/snapshot:
    post:
      summary: Create database snapshot
      operationId: databaseBackupSnapshot
      tags: [Backup]
      responses:
        '202':
          description: Snapshot job queued

  /api/v1/backup/database/upload:
    post:
      summary: Upload database backup
      operationId: databaseBackupUpload
      tags: [Backup]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Upload complete

  /api/v1/backup/database/restore:
    post:
      summary: Restore from database backup
      operationId: databaseBackupRestore
      tags: [Backup]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename]
              properties:
                filename:
                  type: string
      responses:
        '200':
          description: Restore complete

  /api/v1/backup/knowledge-archive/{filename}:
    get:
      summary: Download knowledge archive
      operationId: knowledgeArchiveDownload
      tags: [Backup]
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Archive file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/backup/knowledge-archive:
    post:
      summary: Upload knowledge archive
      operationId: knowledgeArchiveUpload
      tags: [Backup]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Upload complete

  /api/v1/backup/list:
    get:
      summary: List all backups
      operationId: listBackups
      tags: [Backup]
      responses:
        '200':
          description: Available backups
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BackupInfo'

  /api/v1/backup/list/{filename}:
    get:
      summary: Get backup info
      operationId: getBackupInfo
      tags: [Backup]
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Backup information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackupInfo'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/v1/backup/swap:
    post:
      summary: Swap active database with backup
      description: Destructive operation - replaces active database
      operationId: swapBackup
      tags: [Backup]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename]
              properties:
                filename:
                  type: string
      responses:
        '200':
          description: Swap complete

  /api/v1/backup/metadata/{filename}:
    get:
      summary: Get backup metadata
      operationId: getBackupMetadata
      tags: [Backup]
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Backup metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackupMetadata'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: Update backup metadata
      operationId: updateBackupMetadata
      tags: [Backup]
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
      responses:
        '204':
          description: Metadata updated

# =============================================================================
# Components
# =============================================================================
components:
  parameters:
    NoteId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    ConceptId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    TargetConceptId:
      name: target_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

    VersionNumber:
      name: version
      in: path
      required: true
      schema:
        type: integer
        minimum: 1

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string

    # Events & Webhooks
    ServerEvent:
      type: object
      required: [type]
      properties:
        type:
          type: string
          enum: [QueueStatus, JobQueued, JobStarted, JobProgress, JobCompleted, JobFailed, NoteUpdated]

    CreateWebhookRequest:
      type: object
      required: [url, events]
      properties:
        url:
          type: string
          format: uri
        secret:
          type: string
          description: HMAC-SHA256 signing secret
        events:
          type: array
          items:
            type: string
          description: Event types to subscribe to (empty = all)
        max_retries:
          type: integer
          default: 3

    Webhook:
      type: object
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
        events:
          type: array
          items:
            type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_triggered_at:
          type: string
          format: date-time
          nullable: true
        failure_count:
          type: integer
        max_retries:
          type: integer

    WebhookDelivery:
      type: object
      properties:
        id:
          type: string
          format: uuid
        webhook_id:
          type: string
          format: uuid
        event_type:
          type: string
        payload:
          type: object
        status_code:
          type: integer
          nullable: true
        response_body:
          type: string
          nullable: true
        delivered_at:
          type: string
          format: date-time
        success:
          type: boolean

    # Notes
    NoteSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        snippet:
          type: string
        created_at_utc:
          type: string
          format: date-time
        updated_at_utc:
          type: string
          format: date-time
        starred:
          type: boolean
        archived:
          type: boolean
        tags:
          type: array
          items:
            type: string
        has_revision:
          type: boolean
        metadata:
          type: object

    NoteFull:
      type: object
      properties:
        note:
          $ref: '#/components/schemas/NoteMeta'
        original:
          $ref: '#/components/schemas/NoteOriginal'
        revised:
          $ref: '#/components/schemas/NoteRevised'
        tags:
          type: array
          items:
            type: string
        links:
          type: array
          items:
            $ref: '#/components/schemas/Link'

    NoteMeta:
      type: object
      properties:
        id:
          type: string
          format: uuid
        collection_id:
          type: string
          format: uuid
          nullable: true
        format:
          type: string
        source:
          type: string
        created_at_utc:
          type: string
          format: date-time
        updated_at_utc:
          type: string
          format: date-time
        starred:
          type: boolean
        archived:
          type: boolean
        last_accessed_at:
          type: string
          format: date-time
          nullable: true
        title:
          type: string
          nullable: true
        metadata:
          type: object

    NoteOriginal:
      type: object
      properties:
        content:
          type: string
        hash:
          type: string
        user_created_at:
          type: string
          format: date-time
          nullable: true
        user_last_edited_at:
          type: string
          format: date-time
          nullable: true

    NoteRevised:
      type: object
      properties:
        content:
          type: string
        last_revision_id:
          type: string
          format: uuid
        ai_metadata:
          type: object
          nullable: true
        ai_generated_at:
          type: string
          format: date-time
          nullable: true
        user_last_edited_at:
          type: string
          format: date-time
          nullable: true
        is_user_edited:
          type: boolean
        generation_count:
          type: integer
        model:
          type: string
          nullable: true

    NotesListResponse:
      type: object
      properties:
        notes:
          type: array
          items:
            $ref: '#/components/schemas/NoteSummary'
        total:
          type: integer

    CreateNoteRequest:
      type: object
      required: [content]
      properties:
        content:
          type: string
          description: Markdown content
        format:
          type: string
          default: markdown
        source:
          type: string
          default: api
        collection_id:
          type: string
          format: uuid
        tags:
          type: array
          items:
            type: string
        revision_mode:
          type: string
          enum: [full, light, none]
          default: full
        metadata:
          type: object

    UpdateNoteRequest:
      type: object
      properties:
        content:
          type: string
        starred:
          type: boolean
        archived:
          type: boolean

    FullDocumentResponse:
      type: object
      required: [id, title, content, is_chunked, tags, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        content:
          type: string
        chunks:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ChunkSummary'
        total_chunks:
          type: integer
          nullable: true
        is_chunked:
          type: boolean
        tags:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ChunkSummary:
      type: object
      required: [id, sequence, title, byte_range]
      properties:
        id:
          type: string
          format: uuid
        sequence:
          type: integer
        title:
          type: string
        byte_range:
          type: array
          items:
            type: integer
          minItems: 2
          maxItems: 2

    Link:
      type: object
      properties:
        id:
          type: string
          format: uuid
        from_note_id:
          type: string
          format: uuid
        to_note_id:
          type: string
          format: uuid
          nullable: true
        to_url:
          type: string
          nullable: true
        kind:
          type: string
        score:
          type: number
        created_at_utc:
          type: string
          format: date-time
        snippet:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true

    Tag:
      type: object
      properties:
        name:
          type: string
        created_at_utc:
          type: string
          format: date-time

    # Versioning
    NoteVersion:
      type: object
      properties:
        version:
          type: integer
        created_at:
          type: string
          format: date-time
        change_summary:
          type: string
          nullable: true
        content_hash:
          type: string

    NoteVersionFull:
      type: object
      properties:
        version:
          type: integer
        content:
          type: string
        created_at:
          type: string
          format: date-time

    VersionDiff:
      type: object
      properties:
        from_version:
          type: integer
        to_version:
          type: integer
        diff:
          type: string
          description: Unified diff format

    # Provenance
    ProvenanceResponse:
      type: object
      properties:
        note_id:
          type: string
          format: uuid
        provenance:
          type: array
          items:
            $ref: '#/components/schemas/ProvenanceActivity'

    ProvenanceActivity:
      type: object
      properties:
        activity:
          type: string
        agent:
          type: string
        timestamp:
          type: string
          format: date-time
        inputs:
          type: array
          items:
            type: string
        outputs:
          type: array
          items:
            type: string
        parameters:
          type: object

    # Search
    SearchResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchHit'
        query:
          type: string
        total:
          type: integer

    SearchHit:
      type: object
      properties:
        note_id:
          type: string
          format: uuid
        score:
          type: number
        snippet:
          type: string

    StrictTagFilterInput:
      type: object
      description: Strict tag filter with SKOS notation resolution
      properties:
        required_tags:
          type: array
          items:
            type: string
          description: All must be present (AND)
        any_tags:
          type: array
          items:
            type: string
          description: At least one must be present (OR)
        excluded_tags:
          type: array
          items:
            type: string
          description: None must be present (NOT)
        required_schemes:
          type: array
          items:
            type: string
        excluded_schemes:
          type: array
          items:
            type: string
        min_tag_count:
          type: integer
        include_untagged:
          type: boolean
          default: true

    # Analytics
    TimelineResponse:
      type: object
      properties:
        granularity:
          type: string
          enum: [day, week, month]
        buckets:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
              created:
                type: integer
              updated:
                type: integer

    ActivityEvent:
      type: object
      properties:
        note_id:
          type: string
          format: uuid
        title:
          type: string
        event_type:
          type: string
        timestamp:
          type: string
          format: date-time

    # Health
    KnowledgeHealth:
      type: object
      properties:
        total_notes:
          type: integer
        total_tags:
          type: integer
        total_links:
          type: integer
        total_embeddings:
          type: integer
        notes_without_embeddings:
          type: integer
        notes_without_links:
          type: integer
        orphan_tags:
          type: integer
        stale_notes:
          type: integer
        average_links_per_note:
          type: number
        average_tags_per_note:
          type: number

    TagCooccurrence:
      type: object
      properties:
        matrix:
          type: array
          items:
            type: object
            properties:
              tag_a:
                type: string
              tag_b:
                type: string
              count:
                type: integer

    # Jobs
    Job:
      type: object
      properties:
        id:
          type: string
          format: uuid
        note_id:
          type: string
          format: uuid
          nullable: true
        job_type:
          type: string
          enum: [ai_revision, embedding, linking, context_update, title_generation, concept_tagging]
        status:
          type: string
          enum: [pending, running, completed, failed, cancelled]
        priority:
          type: integer
        payload:
          type: object
          nullable: true
        result:
          type: object
          nullable: true
        error_message:
          type: string
          nullable: true
        progress_percent:
          type: integer
        progress_message:
          type: string
          nullable: true
        retry_count:
          type: integer
        max_retries:
          type: integer
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true

    CreateJobRequest:
      type: object
      required: [job_type]
      properties:
        note_id:
          type: string
          format: uuid
        job_type:
          type: string
          enum: [ai_revision, embedding, linking, context_update, title_generation, concept_tagging]
        priority:
          type: integer
        payload:
          type: object

    QueueStats:
      type: object
      properties:
        total:
          type: integer
        by_status:
          type: object
          additionalProperties:
            type: integer
        by_type:
          type: object
          additionalProperties:
            type: integer

    # Document Types
    DocumentType:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        filename_patterns:
          type: array
          items:
            type: string
        magic_content_patterns:
          type: array
          items:
            type: string
        chunk_strategy:
          type: string
          enum: [semantic, syntactic, fixed, none]
        chunk_size:
          type: integer
        chunk_overlap:
          type: integer
        is_builtin:
          type: boolean

    DetectDocumentTypeResponse:
      type: object
      properties:
        document_type:
          $ref: '#/components/schemas/DocumentType'
        confidence:
          type: number
        matched_by:
          type: string
          enum: [filename, content, default]

    # Archives
    Archive:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
          nullable: true
        retention_policy:
          type: string
          nullable: true
        is_default:
          type: boolean
        created_at:
          type: string
          format: date-time

    ArchiveStats:
      type: object
      properties:
        note_count:
          type: integer
        total_size_bytes:
          type: integer
        oldest_note:
          type: string
          format: date-time
          nullable: true
        newest_note:
          type: string
          format: date-time
          nullable: true

    # SKOS
    ConceptScheme:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
          nullable: true
        notation:
          type: string
        uri:
          type: string
          nullable: true
        concept_count:
          type: integer
        created_at:
          type: string
          format: date-time

    Concept:
      type: object
      properties:
        id:
          type: string
          format: uuid
        scheme_id:
          type: string
          format: uuid
        pref_label:
          type: string
        notation:
          type: string
        definition:
          type: string
          nullable: true
        scope_note:
          type: string
          nullable: true
        alt_labels:
          type: array
          items:
            type: string
        hidden_labels:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [active, deprecated, proposed]
        facet_type:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    ConceptFull:
      allOf:
        - $ref: '#/components/schemas/Concept'
        - type: object
          properties:
            broader:
              type: array
              items:
                $ref: '#/components/schemas/Concept'
            narrower:
              type: array
              items:
                $ref: '#/components/schemas/Concept'
            related:
              type: array
              items:
                $ref: '#/components/schemas/Concept'

    ConceptSuggestion:
      type: object
      properties:
        id:
          type: string
          format: uuid
        pref_label:
          type: string
        notation:
          type: string
        scheme_notation:
          type: string

    GovernanceStats:
      type: object
      properties:
        total_concepts:
          type: integer
        active:
          type: integer
        deprecated:
          type: integer
        proposed:
          type: integer
        total_schemes:
          type: integer
        total_collections:
          type: integer

    SkosCollection:
      type: object
      properties:
        id:
          type: string
          format: uuid
        label:
          type: string
        description:
          type: string
          nullable: true
        notation:
          type: string
          nullable: true
        member_count:
          type: integer
        created_at:
          type: string
          format: date-time

    # Collections
    Collection:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        parent_id:
          type: string
          format: uuid
          nullable: true
        note_count:
          type: integer
        created_at:
          type: string
          format: date-time

    # Embedding Sets & Configs
    EmbeddingSet:
      type: object
      properties:
        id:
          type: string
          format: uuid
        slug:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        set_type:
          type: string
          enum: [filter, full]
        embedding_config_id:
          type: string
          format: uuid
        member_count:
          type: integer
        auto_embed_rules:
          type: object
          nullable: true
        created_at:
          type: string
          format: date-time

    EmbeddingConfig:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        model_name:
          type: string
        dimensions:
          type: integer
        distance_metric:
          type: string
          enum: [cosine, l2, ip]
        mrl_dimensions:
          type: integer
          nullable: true
          description: Matryoshka Representation Learning dimensions for 12x storage savings
        is_default:
          type: boolean
        description:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    # Graph
    GraphResponse:
      type: object
      properties:
        nodes:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              title:
                type: string
              depth:
                type: integer
        edges:
          type: array
          items:
            type: object
            properties:
              from:
                type: string
                format: uuid
              to:
                type: string
                format: uuid
              kind:
                type: string
              score:
                type: number

    # Templates
    Template:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        content:
          type: string
          description: Template with {{variable}} placeholders
        tags:
          type: array
          items:
            type: string
        category:
          type: string
          nullable: true
        variables:
          type: array
          items:
            type: string
          description: Extracted variable names
        created_at:
          type: string
          format: date-time

    # Backup
    BackupInfo:
      type: object
      properties:
        filename:
          type: string
        size_bytes:
          type: integer
        created_at:
          type: string
          format: date-time
        backup_type:
          type: string
          enum: [json, database, knowledge_shard, knowledge_archive]
        metadata:
          $ref: '#/components/schemas/BackupMetadata'

    BackupMetadata:
      type: object
      properties:
        title:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        note_count:
          type: integer
        tag_count:
          type: integer
        created_at:
          type: string
          format: date-time
        version:
          type: string

    BackupStatus:
      type: object
      properties:
        last_backup:
          type: string
          format: date-time
          nullable: true
        backup_in_progress:
          type: boolean
        available_backups:
          type: integer

    ImportResult:
      type: object
      properties:
        imported:
          type: integer
        skipped:
          type: integer
        errors:
          type: integer
        error_details:
          type: array
          items:
            type: string

    # System
    MemoryInfo:
      type: object
      properties:
        database_size:
          type: string
        note_count:
          type: integer
        embedding_count:
          type: integer
        link_count:
          type: integer
        tag_count:
          type: integer
        job_count:
          type: integer
        version:
          type: string
        uptime:
          type: string

    RateLimitStatus:
      type: object
      properties:
        enabled:
          type: boolean
        remaining:
          type: integer
        limit:
          type: integer
        reset_at:
          type: string
          format: date-time
          nullable: true

    PaginationMeta:
      type: object
      properties:
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
        has_more:
          type: boolean

    # OAuth2 Schemas
    AuthorizationServerMetadata:
      type: object
      properties:
        issuer:
          type: string
        authorization_endpoint:
          type: string
        token_endpoint:
          type: string
        registration_endpoint:
          type: string
        introspection_endpoint:
          type: string
        revocation_endpoint:
          type: string
        response_types_supported:
          type: array
          items:
            type: string
        grant_types_supported:
          type: array
          items:
            type: string
        token_endpoint_auth_methods_supported:
          type: array
          items:
            type: string
        scopes_supported:
          type: array
          items:
            type: string
        code_challenge_methods_supported:
          type: array
          items:
            type: string

    ClientRegistrationRequest:
      type: object
      required: [client_name]
      properties:
        client_name:
          type: string
        redirect_uris:
          type: array
          items:
            type: string
        grant_types:
          type: array
          items:
            type: string
            enum: [authorization_code, client_credentials, refresh_token]
        response_types:
          type: array
          items:
            type: string
            enum: [code, token]
        scope:
          type: string
        token_endpoint_auth_method:
          type: string
          enum: [client_secret_basic, client_secret_post, none]
        client_uri:
          type: string
        logo_uri:
          type: string
        contacts:
          type: array
          items:
            type: string
        software_id:
          type: string
        software_version:
          type: string
        software_statement:
          type: string

    ClientRegistrationResponse:
      type: object
      properties:
        client_id:
          type: string
        client_secret:
          type: string
        client_id_issued_at:
          type: integer
        client_secret_expires_at:
          type: integer
        client_name:
          type: string
        redirect_uris:
          type: array
          items:
            type: string
        grant_types:
          type: array
          items:
            type: string
        response_types:
          type: array
          items:
            type: string
        scope:
          type: string
        token_endpoint_auth_method:
          type: string
        registration_access_token:
          type: string
        registration_client_uri:
          type: string

    TokenRequest:
      type: object
      required: [grant_type]
      properties:
        grant_type:
          type: string
          enum: [authorization_code, client_credentials, refresh_token]
        code:
          type: string
        redirect_uri:
          type: string
        refresh_token:
          type: string
        scope:
          type: string
        code_verifier:
          type: string
        client_id:
          type: string
        client_secret:
          type: string

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
        refresh_token:
          type: string
        scope:
          type: string

    TokenIntrospectionResponse:
      type: object
      properties:
        active:
          type: boolean
        scope:
          type: string
        client_id:
          type: string
        username:
          type: string
        token_type:
          type: string
        exp:
          type: integer
        iat:
          type: integer
        sub:
          type: string
        aud:
          type: string
        iss:
          type: string

    OAuthError:
      type: object
      properties:
        error:
          type: string
          enum: [invalid_request, invalid_client, invalid_grant, unauthorized_client, unsupported_grant_type, invalid_scope, server_error]
        error_description:
          type: string
        error_uri:
          type: string

    ApiKey:
      type: object
      properties:
        id:
          type: string
          format: uuid
        key_prefix:
          type: string
        name:
          type: string
        description:
          type: string
        scope:
          type: string
        rate_limit_per_minute:
          type: integer
        rate_limit_per_hour:
          type: integer
        last_used_at:
          type: string
          format: date-time
        use_count:
          type: integer
        is_active:
          type: boolean
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

    CreateApiKeyRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
        scope:
          type: string
          default: read
        expires_in_days:
          type: integer

    CreateApiKeyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        api_key:
          type: string
          description: The full API key (only shown once)
        key_prefix:
          type: string
        name:
          type: string
        scope:
          type: string
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Bearer token (OAuth2 access token or API key)

    oauth2:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: /oauth/token
          scopes:
            read: Read access to notes, tags, and search
            write: Create and update notes and tags
            delete: Delete notes
            admin: Administrative access
            mcp: MCP server access (includes read and write)
        authorizationCode:
          authorizationUrl: /oauth/authorize
          tokenUrl: /oauth/token
          scopes:
            read: Read access to notes, tags, and search
            write: Create and update notes and tags
            delete: Delete notes
            admin: Administrative access
            mcp: MCP server access (includes read and write)

    clientCredentials:
      type: http
      scheme: basic
      description: Client credentials (client_id:client_secret)
