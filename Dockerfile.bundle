# Dockerfile.bundle - All-in-one FortÃ©mi with embedded PostgreSQL + MCP
#
# Usage:
#   docker build -f Dockerfile.bundle -t fortemi:bundle .
#   docker run -d -p 3000:3000 -p 3001:3001 -v fortemi-data:/var/lib/postgresql/data fortemi:bundle
#
# Build stage for Rust API
FROM rust:slim-bookworm AS builder

ARG VERSION=dev
ARG GIT_SHA=unknown
ARG BUILD_DATE=unknown
ARG CARGO_BUILD_JOBS=8

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config \
    libssl-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

COPY Cargo.toml Cargo.lock ./
COPY crates ./crates
COPY migrations ./migrations

ENV MATRIC_VERSION=${VERSION}
ENV MATRIC_GIT_SHA=${GIT_SHA}
ENV MATRIC_BUILD_DATE=${BUILD_DATE}

RUN cargo build --release --jobs ${CARGO_BUILD_JOBS} --package matric-api --package matric-crypto && \
    cp target/release/matric-api /app/matric-api && \
    cp target/release/matric-pke /app/matric-pke

# GLiNER build stage - install Python deps and pre-download model
FROM python:3.11-slim AS gliner-builder

WORKDIR /gliner

COPY build/gliner/requirements.txt .
RUN pip install --no-cache-dir --target /gliner/site-packages -r requirements.txt

# Pre-download the model at build time (avoids first-request delay)
ARG GLINER_MODEL=urchade/gliner_large-v2.1
ENV PYTHONPATH=/gliner/site-packages
RUN python -c "from gliner import GLiNER; GLiNER.from_pretrained('${GLINER_MODEL}')"

COPY build/gliner/app.py .

# Runtime stage - based on pgvector image for PostgreSQL + pgvector
FROM pgvector/pgvector:pg18 AS runtime

ARG VERSION=dev
ARG GIT_SHA=unknown
ARG BUILD_DATE=unknown

LABEL org.opencontainers.image.title="fortemi-bundle"
LABEL org.opencontainers.image.description="AI-enhanced knowledge base - all-in-one with PostgreSQL and MCP"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.revision="${GIT_SHA}"
LABEL org.opencontainers.image.created="${BUILD_DATE}"

# Install runtime dependencies for matric-api, Node.js for MCP server, PostGIS, and extraction toolchain
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    libssl3 \
    curl \
    gnupg \
    # Extraction toolchain
    poppler-utils \
    tesseract-ocr \
    tesseract-ocr-eng \
    pandoc \
    ffmpeg \
    # PostGIS for spatial/geographic queries (W3C PROV prov:atLocation)
    postgresql-18-postgis-3 \
    postgresql-18-postgis-3-scripts \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main" > /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy binaries from builder
COPY --from=builder /app/matric-api /app/matric-api
COPY --from=builder /app/matric-pke /usr/local/bin/matric-pke

# Copy migrations
COPY migrations /app/migrations

# Copy MCP server
COPY mcp-server /app/mcp-server

# Install MCP server dependencies
WORKDIR /app/mcp-server
RUN npm ci --omit=dev

# Copy Three.js 3D renderer for GLB/GLTF multi-view extraction
COPY docker/threejs-renderer /app/threejs-renderer

# Install headless-gl dependencies for WebGL server-side rendering
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgl1-mesa-dev \
    libxi-dev \
    libxext-dev \
    xvfb \
    xauth \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install Three.js renderer dependencies
WORKDIR /app/threejs-renderer
RUN npm install --production && \
    npm install pngjs canvas --production

WORKDIR /app

# Copy GLiNER NER sidecar (embedded, CPU-only, zero-shot entity extraction)
COPY --from=gliner-builder /gliner/site-packages /app/gliner/site-packages
COPY --from=gliner-builder /gliner/app.py /app/gliner/app.py
COPY --from=gliner-builder /root/.cache/huggingface /root/.cache/huggingface

# Copy seed data for support archive (fortemi-docs)
COPY docker/seed-data /app/seed-data

# Copy entrypoint and seed scripts
COPY docker/bundle-entrypoint.sh /app/entrypoint.sh
COPY docker/seed-support-archive.sh /app/seed-support-archive.sh
RUN chmod +x /app/entrypoint.sh /app/seed-support-archive.sh

# Version environment variables
ENV MATRIC_VERSION=${VERSION}
ENV MATRIC_GIT_SHA=${GIT_SHA}
ENV MATRIC_BUILD_DATE=${BUILD_DATE}

# =============================================================================
# PostgreSQL environment
# =============================================================================
ENV POSTGRES_USER=matric
ENV POSTGRES_PASSWORD=matric
ENV POSTGRES_DB=matric
ENV PGDATA=/var/lib/postgresql/data

# =============================================================================
# Matric API environment
# =============================================================================
ENV DATABASE_URL=postgres://matric:matric@localhost:5432/matric
ENV HOST=0.0.0.0
ENV PORT=3000
ENV RUST_LOG=info

# OAuth/Auth - Set ISSUER_URL to your external URL for OAuth discovery
# ENV ISSUER_URL=https://memory.example.com
# OAuth token lifetime (seconds, default: 3600 = 1 hour)
# ENV OAUTH_TOKEN_LIFETIME_SECS=3600
# MCP token lifetime (seconds, default: 14400 = 4 hours)
# ENV OAUTH_MCP_TOKEN_LIFETIME_SECS=14400

# Rate limiting (disable for development/testing)
ENV RATE_LIMIT_ENABLED=false

# Full-text search: enable multilingual, emoji, and CJK support
ENV FTS_SCRIPT_DETECTION=true
ENV FTS_TRIGRAM_FALLBACK=true
ENV FTS_BIGRAM_CJK=true
ENV FTS_MULTILINGUAL_CONFIGS=true
# ENV RATE_LIMIT_REQUESTS=100
# ENV RATE_LIMIT_PERIOD_SECS=60

# Logging
# ENV LOG_FORMAT=json
# ENV LOG_FILE=/var/log/matric/api.log
# ENV LOG_ANSI=false

# Background worker (enabled by default)
# ENV WORKER_ENABLED=true

# =============================================================================
# 3D Model Renderer (Three.js)
# =============================================================================
# Internal renderer URL - points to the bundled Three.js renderer
ENV RENDERER_URL=http://localhost:8080
ENV RENDERER_PORT=8080

# Backup configuration
# ENV BACKUP_DEST=/var/backups/matric-memory
# ENV BACKUP_SCRIPT_PATH=/app/scripts/backup.sh

# =============================================================================
# Ollama (local LLM) configuration - for embeddings and generation
# =============================================================================
# ENV OLLAMA_BASE=http://localhost:11434
# ENV OLLAMA_HOST=http://localhost:11434
# ENV OLLAMA_EMBED_MODEL=nomic-embed-text
# ENV OLLAMA_GEN_MODEL=llama3.2
# ENV OLLAMA_EMBED_DIM=768

# =============================================================================
# OpenAI configuration - alternative to Ollama
# =============================================================================
# ENV OPENAI_BASE_URL=https://api.openai.com/v1
# ENV OPENAI_API_KEY=sk-xxx
# ENV OPENAI_EMBED_MODEL=text-embedding-3-small
# ENV OPENAI_GEN_MODEL=gpt-4o-mini
# ENV OPENAI_EMBED_DIM=1536
# ENV OPENAI_TIMEOUT=30
# ENV OPENAI_SKIP_TLS_VERIFY=false

# =============================================================================
# MCP Server environment
# =============================================================================
ENV MCP_TRANSPORT=http
ENV MCP_PORT=3001
ENV MATRIC_API_URL=http://localhost:3000
# MCP_BASE_URL should be set to external URL (e.g., https://memory.example.com/mcp)
# ENV MCP_BASE_URL=https://memory.example.com/mcp

# MCP OAuth client credentials (required for token introspection)
# Register a client via POST /oauth/register then set these
# ENV MCP_CLIENT_ID=mm_xxx
# ENV MCP_CLIENT_SECRET=xxx

# =============================================================================
# GLiNER NER (embedded, CPU-only)
# =============================================================================
ENV GLINER_BASE_URL=http://localhost:8090
ENV GLINER_MODEL=urchade/gliner_large-v2.1
ENV GLINER_PORT=8090
ENV GLINER_THRESHOLD=0.3

# Expose API and MCP ports
EXPOSE 3000 3001

# Health check against the API
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# Data volumes for persistence
VOLUME ["/var/lib/postgresql/data", "/var/lib/matric/files"]

# Use custom entrypoint that starts PostgreSQL, runs migrations, then starts API + MCP
ENTRYPOINT ["/app/entrypoint.sh"]
