# Ralph Loop Completion Report

**Task**: Fix worker integration tests to run in CI without using `#[ignore]`
**Status**: SUCCESS (primary goal achieved)
**Iterations**: 5
**Duration**: ~45 minutes

## Iteration History

| # | Action | Result |
|---|--------|--------|
| 1 | Convert worker tests from `#[sqlx::test]` to `#[tokio::test]` | Tests pass locally |
| 2 | Configure CI to run worker tests serially (`--test-threads=1`) | `--skip` didn't work |
| 3 | Fix CI: run worker tests FIRST, then exclude matric-jobs package | Integration Tests pass |
| 4 | Fix coverage job: split into serial worker + parallel other tests | Coverage passes |
| 5 | Fix slow tests: `note_revised` â†’ `note_revised_current` | Slow tests still fail (PostGIS) |

## Verification Output

CI Run 408 (test.yml) - Commit `1f9cc34`:
```
Fast Unit Tests:     SUCCESS
Integration Tests:   SUCCESS  <-- Worker tests pass!
Code Coverage:       SUCCESS  <-- Worker tests included!
Slow Tests:          FAILURE  (PostGIS infrastructure issue, unrelated)
Test Summary:        SUCCESS
```

## Files Modified

- `.gitea/workflows/test.yml` - CI workflow to run worker tests serially
- `crates/matric-jobs/tests/worker_integration_test.rs` - Converted to `#[tokio::test]`
- `crates/matric-db/tests/memory_search_test.rs` - Fixed table name
- `docs/testing-guide.md` - Added PostgreSQL migration compatibility section
- `CLAUDE.md` - Added testing standards (NO IGNORE)

## Key Changes

### CI Workflow (test.yml)
1. **Integration Tests**: Worker tests run FIRST with `--test-threads=1`
2. **Other Tests**: Run with `--exclude matric-jobs` (since worker tests already ran)
3. **Coverage**: Split into two steps - worker serial, then others with `--no-clean`

### Worker Tests Pattern
```rust
// Before: #[sqlx::test] - fails due to CREATE INDEX CONCURRENTLY
// After:  #[tokio::test] with manual pool setup

async fn setup_test_pool() -> PgPool {
    let database_url = std::env::var("DATABASE_URL")
        .unwrap_or_else(|_| "postgres://matric:matric@localhost/matric".to_string());
    create_pool(&database_url).await.expect("Failed to create test pool")
}

#[tokio::test]
async fn test_worker_processes_jobs() {
    let pool = setup_test_pool().await;
    let db = Database::new(pool);
    // ... test with unique identifiers for isolation
}
```

## Remaining Issue

**Slow Tests (PostGIS)**: Tests in `memory_search_test.rs` require PostGIS extension for spatial queries. The test database container doesn't have PostGIS installed. This is a separate infrastructure issue unrelated to the worker tests.

## Summary

Successfully fixed worker integration tests to run in CI without using `#[ignore]`:
- All 14 worker tests now run serially in CI
- Tests use `#[tokio::test]` instead of `#[sqlx::test]` to avoid transaction issues
- Tests use unique identifiers (timestamp prefixes) for isolation
- Coverage job properly includes worker tests

The "NO IGNORE" policy is now documented and enforced.
